<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuvei Apple Pay WebSDK - Technical Launch Plan</title>
    <meta name="description" content="Technical implementation guide for Nuvei Apple Pay WebSDK integration">
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css">
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Nuvei Apple Pay</h2>
            <p>WebSDK Guide</p>
            <button id="theme-toggle" class="theme-toggle-button">
                <svg id="theme-toggle-light-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
        <ul class="nav-list" id="nav-list">
            <!-- Navigation will be generated by JavaScript -->
        </ul>
    </nav>

    <main class="main-content">
        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle navigation">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <header class="document-header">
            <div class="header-badge">Technical Documentation</div>
            <h1>Nuvei Apple Pay via WebSDK</h1>
            <p class="subtitle">Technical & Launch Plan</p>
            <div class="document-meta">
                <div class="meta-item">
                    <span class="meta-label">Version:</span>
                    <span class="meta-value">1.0</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Last Updated:</span>
                    <span class="meta-value">July 21, 2025</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Target Readers:</span>
                    <span class="meta-value">Engineers, Architects, QA, Product Teams</span>
                </div>
            </div>
        </header>


        <section id="purpose-scope" class="content-section">
            <h2>1. Purpose & Scope</h2>
            <p>Implement Apple Pay as an Alternative Payment Method (APM) in our web checkout using the <strong>Nuvei WebSDK</strong>. The WebSDK will:</p>
            <ul class="feature-list">
                <li>Expose an Apple Pay button (static approach under our control; gallery-initiated flow also supported)</li>
                <li>Collect the Apple Pay token (encrypted payment blob) from the shopper's Apple device via Apple JS APIs</li>
                <li>Submit a <code>createPayment()</code> call through Nuvei WebSDK using the Apple Pay token as an <strong>externalTokenProvider = "ApplePay"</strong> with the <code>mobileToken</code> payload</li>
                <li>Support both <strong>Sandbox (INT)</strong> and <strong>Production</strong> environments</li>
                <li>Support optional recurring flows (initial + subsequent) using Nuvei tokenization / UPOs</li>
            </ul>
            <div class="callout callout-warning">
                <strong>Out of scope:</strong> Native iOS app flows, Payment Page/IFrame flows, merchant-side direct REST decrypt flows (except in Appendix for reference), Payouts.
            </div>
        </section>

        <section id="architecture" class="content-section">
            <h2>2. High-Level Architecture & Data Flow</h2>
            <div class="architecture-diagram">
                <div class="flow-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3>Shopper Browser (Safari / iOS / macOS)</h3>
                        <p>Shopper clicks our Checkout → we display eligible Methods incl. Apple Pay.</p>
                    </div>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3>Apple Pay JS APIs</h3>
                        <p>Apple sheet collects cards + authenticates shopper (TouchID/FaceID/Passcode).</p>
                    </div>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3>Encrypted Apple Pay Payment Token</h3>
                        <p>Pass token into Nuvei WebSDK createPayment() externalToken.card.mobileToken.</p>
                    </div>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h3>Nuvei Gateway</h3>
                        <p>Nuvei decrypts Apple Pay token; routes auth to issuer/acquirer.</p>
                    </div>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <h3>Authorization Result</h3>
                        <p>Merchant Server validates via /getPaymentStatus or DMN webhook → updates Order, triggers fulfillment.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="prerequisites" class="content-section">
            <h2>3. Prerequisites Checklist</h2>
            
            <div class="checklist-category">
                <h3>Merchant / Org Requirements</h3>
                <ul class="checklist">
                    <li>Active <strong>Nuvei merchantId + merchantSiteId</strong> in both Sandbox (INT) and Production</li>
                    <li><strong>Secret Key</strong> securely stored server-side (never exposed client-side)</li>
                    <li>Apple Pay enabled for the merchant account by Nuvei (confirm with your Nuvei account manager)</li>
                </ul>
            </div>

            <div class="checklist-category">
                <h3>Apple Registration Requirements</h3>
                <ul class="checklist">
                    <li>Valid <strong>Apple Developer Program</strong> account (Account Holder or Admin role) OR use Nuvei's <strong>Simplified Apple Pay Setup</strong> in Control Panel (recommended when available)</li>
                    <li><strong>Merchant ID</strong> created in Apple Dev portal (never expires; reusable across sites/apps)</li>
                    <li><strong>Domain registration & verification</strong> for every FQDN where the Apple Pay button will appear</li>
                    <li><strong>Valid SSL cert</strong>; all Apple Pay surfaces must be HTTPS; server supports TLS 1.2+</li>
                    <li>Server configured per Apple's "Setting Up Your Server / Allow Apple IP Addresses" guidance</li>
                </ul>
            </div>

            <div class="checklist-category">
                <h3>Environment & Device Requirements</h3>
                <ul class="checklist">
                    <li>Shopper using Safari on supported Apple hardware signed into iCloud with an active card in Wallet</li>
                    <li>Test devices enrolled with <strong>Apple Pay Sandbox tester accounts</strong> for QA</li>
                </ul>
            </div>

            <div class="checklist-category">
                <h3>Internal Engineering Prep</h3>
                <ul class="checklist">
                    <li>Decide which checkout surfaces show Apple Pay (Cart page, mini-cart, express checkout, payment step?)</li>
                    <li>Collect mapping table: currency support, country eligibility, product eligibility rules</li>
                    <li>Confirm tax/amount presentation parity between standard card flow and Apple Pay express flow</li>
                </ul>
            </div>
        </section>

        <section id="environments" class="content-section">
            <h2>4. Environments, Credentials & Endpoints</h2>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Environment</th>
                            <th>Nuvei env Param</th>
                            <th>Base API Host</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Test / Integration</strong></td>
                            <td><code>int</code></td>
                            <td><code>https://ppp-test.nuvei.com/ppp/api/v1/</code></td>
                            <td>Used for dev + QA; uses Apple Pay Sandbox accounts</td>
                        </tr>
                        <tr>
                            <td><strong>Live / Production</strong></td>
                            <td><code>prod</code> (default if omitted)</td>
                            <td><code>https://secure.safecharge.com/</code></td>
                            <td>Live traffic. Use Production Apple Pay domain + certs</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="callout callout-security">
                <h4>Credential Handling</h4>
                <ul>
                    <li>Store <code>merchantId</code>, <code>merchantSiteId</code>, <code>merchantSecretKey</code> in secure server vault (HashiCorp Vault, KMS, etc.)</li>
                    <li>Rotate keys per Nuvei policy; update CI/CD secrets store</li>
                    <li><strong>NEVER</strong> expose secret key in front-end code; all signed requests originate server-side</li>
                </ul>
            </div>
        </section>

        <section id="key-parameters" class="content-section">
            <h2>5. Key Nuvei Objects & Parameters</h2>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Location</th>
                            <th>Required</th>
                            <th>Description / Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>sessionToken</code></td>
                            <td>Returned by <code>/openOrder</code>; passed to WebSDK & payment calls</td>
                            <td>Yes</td>
                            <td>Authenticates the session/order context</td>
                        </tr>
                        <tr>
                            <td><code>merchantId</code></td>
                            <td>WebSDK init & payment</td>
                            <td>Yes</td>
                            <td>Provided by Nuvei</td>
                        </tr>
                        <tr>
                            <td><code>merchantSiteId</code></td>
                            <td>WebSDK init & payment</td>
                            <td>Yes</td>
                            <td>Provided by Nuvei; site-level segmentation</td>
                        </tr>
                        <tr>
                            <td><code>paymentOption.card.externalToken.externalTokenProvider</code></td>
                            <td><code>createPayment()</code> payload</td>
                            <td>Yes</td>
                            <td>Must be literal <code>ApplePay</code></td>
                        </tr>
                        <tr>
                            <td><code>billingAddress.email</code> OR <code>billingAddress.phone</code></td>
                            <td>Required</td>
                            <td>Yes</td>
                            <td>Either email or phone must be provided</td>
                        </tr>
                        <tr>
                            <td><code>billingAddress.country</code></td>
                            <td>Required</td>
                            <td>Yes</td>
                            <td>Mandatory billing country code</td>
                        </tr>
                        <tr>
                            <td><code>clientUniqueId</code></td>
                            <td>Optional</td>
                            <td>No</td>
                            <td>Merchant-side idempotency / reconciliation</td>
                        </tr>
                        <tr>
                            <td><code>userTokenId</code></td>
                            <td>Optional (Rec.)</td>
                            <td>No</td>
                            <td>Enables Nuvei UPO creation for recurring / COF</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="callout callout-warning">
                <h4>Important Requirements</h4>
                <ul>
                    <li><strong>Billing Country:</strong> Always mandatory - must be provided in <code>billingAddress.country</code></li>
                    <li><strong>Contact Information:</strong> Either <code>billingAddress.email</code> OR <code>billingAddress.phone</code> is required</li>
                    <li><strong>External Token Provider:</strong> Only <code>externalTokenProvider = "ApplePay"</code> is needed - the mobile token is handled automatically by the WebSDK</li>
                </ul>
            </div>
        </section>

        <section id="implementation" class="content-section">
            <h2>6. Implementation Overview</h2>
            <p>We break execution into <strong>Backend</strong>, <strong>Frontend</strong>, <strong>QA/Testing</strong>, <strong>Compliance & Security</strong>, <strong>Launch & Monitoring</strong>.</p>

            <div class="implementation-grid">
                <div class="implementation-card">
                    <h3>Backend Tasks</h3>
                    <ul>
                        <li>/openOrder Endpoint Wrapper</li>
                        <li>DMN Listener / Webhook</li>
                        <li>/getPaymentStatus Fallback</li>
                        <li>Logging & Observability</li>
                        <li>Config Management</li>
                    </ul>
                </div>
                <div class="implementation-card">
                    <h3>Frontend Tasks</h3>
                    <ul>
                        <li>Include Nuvei WebSDK Library</li>
                        <li>Check Device Capability</li>
                        <li>Initialize WebSDK</li>
                        <li>Attach Click Handler</li>
                        <li>Result Handling</li>
                    </ul>
                </div>
                <div class="implementation-card">
                    <h3>Testing Strategy</h3>
                    <ul>
                        <li>Sandbox Environment Setup</li>
                        <li>Test Data Configuration</li>
                        <li>Functional Test Matrix</li>
                        <li>Integration Validation</li>
                    </ul>
                </div>
                <div class="implementation-card">
                    <h3>Security & Compliance</h3>
                    <ul>
                        <li>Token Handling</li>
                        <li>PCI DSS Compliance</li>
                        <li>HTTPS Enforcement</li>
                        <li>Domain Security</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="frontend-implementation" class="content-section">
            <h2>7. Frontend Implementation (Static Apple Pay Button)</h2>
            <p>This follows Nuvei's <strong>Static Pay Button (Web SDK)</strong> procedure. The entire Apple Pay flow is driven by the WebSDK helper <code>createApplePayPayment()</code>.</p>

            <div class="code-section">
                <h3>1. Include the Nuvei WebSDK Library</h3>
                <pre><code class="language-html">&lt;script src="https://cdn.safecharge.com/safecharge_resources/v1/websdk/safecharge.js"&gt;&lt;/script&gt;</code></pre>
            </div>

            <div class="code-section">
                <h3>2. Check Device Capability & Inject Button</h3>
                <pre><code class="language-html">&lt;!-- Optional placeholder where the button will be injected --&gt;
&lt;div id="apple-pay-button-container"&gt;&lt;/div&gt;
&lt;script&gt;
if (window.ApplePaySession) {
    const merchantIdentifier = 'your.merchant.id'; // Apple‐registered merchant ID
    ApplePaySession.canMakePaymentsWithActiveCard(merchantIdentifier)
      .then(function (canPay) {
        if (canPay) {
          document.getElementById('apple-pay-button-container').innerHTML =
            '&lt;button id="apple-pay-button" class="apple-pay-button"&gt;Apple Pay&lt;/button&gt;';
        }
      });
}
&lt;/script&gt;</code></pre>
            </div>

            <div class="code-section">
                <h3>3. Initialize WebSDK</h3>
                <pre><code class="language-javascript">const sfc = SafeCharge({
  sessionToken: SESSION_TOKEN_FROM_OPENORDER, // generated server‑side
  merchantId: NUVEI_MERCHANT_ID,
  merchantSiteId: NUVEI_MERCHANT_SITE_ID,
  env: 'int' // or 'prod'
});</code></pre>
            </div>

            <div class="code-section">
                <h3>4. Attach Click Handler & Call createApplePayPayment()</h3>
                <pre><code class="language-javascript">document.addEventListener('click', function (e) {
  if (e.target && e.target.id === 'apple-pay-button') {
    sfc.createApplePayPayment({
      sessionToken: SESSION_TOKEN_FROM_OPENORDER,
      merchantId: NUVEI_MERCHANT_ID,
      merchantSiteId: NUVEI_MERCHANT_SITE_ID,
      clientUniqueId: ORDER_ID_OPTIONAL,
      env: 'int',                       // or 'prod'
      countryCode: 'US',                // shopper country
      currencyCode: 'USD',              // transaction currency
      total: { label: 'Your Company', amount: '19.99' },
      applePay3Dflow: 'disable',        // default; enable if Nuvei instructs
      collectUserDetails: false,        // set true to pull billing/shipping from Apple sheet
      billingAddress: {
        email: shopperEmail,            // Required: email OR phone
        phone: shopperPhone,            // Alternative to email
        country: shopperCountry         // Required: billing country
      }
    }, handlePaymentResponse);
  }
});

function handlePaymentResponse(res) {
  // APPROVED / DECLINED / PENDING—hand over to backend validation
  console.log(res);
}</code></pre>
            </div>
        </section>

        <section id="error-handling" class="content-section">
            <h2>8. Error Handling & Idempotency</h2>
            
            <div class="error-handling-grid">
                <div class="error-card">
                    <h3>Client-Side (WebSDK Response)</h3>
                    <ul>
                        <li>Inspect <code>result</code> for immediate UI messaging: <code>APPROVED</code>, <code>DECLINED</code>, <code>ERROR</code>, <code>PENDING</code></li>
                        <li>Use <code>errorDescription</code> when present for shopper-friendly fallback copy (sanitize!)</li>
                    </ul>
                </div>
                <div class="error-card">
                    <h3>Server-Side Validation</h3>
                    <ul>
                        <li>Always validate outcome server-side: call <code>/getPaymentStatus</code> OR rely on DMN payloads (recommended)</li>
                        <li>Implement <strong>idempotent order states</strong> keyed by <code>clientUniqueId</code> + Nuvei <code>transactionId</code></li>
                    </ul>
                </div>
            </div>

            <h3>Common Error Codes</h3>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Error Code</th>
                            <th>Meaning</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1064</td>
                            <td>Invalid session token / one order per session</td>
                            <td>Regen session; restart checkout</td>
                        </tr>
                        <tr>
                            <td>1069</td>
                            <td>Session expired</td>
                            <td>Prompt shopper to retry; create new order</td>
                        </tr>
                        <tr>
                            <td>9101</td>
                            <td>3DS required for Apple Pay transaction</td>
                            <td>Fallback to 3DS-capable path or contact Nuvei</td>
                        </tr>
                        <tr>
                            <td>9072</td>
                            <td>Payment still in progress</td>
                            <td>Poll /getPaymentStatus; show spinner</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="testing" class="content-section">
            <h2>9. Testing Strategy</h2>
            
            <div class="testing-grid">
                <div class="testing-card">
                    <h3>Test Environments</h3>
                    <ul>
                        <li><strong>Nuvei INT Sandbox</strong> + <strong>Apple Pay Sandbox testers</strong></li>
                        <li>Mirror production domains in sandbox (e.g., <code>sandbox.example.com</code>)</li>
                        <li>Ensure domain registered in Apple Dev under Sandbox where applicable</li>
                    </ul>
                </div>
                <div class="testing-card">
                    <h3>Test Data</h3>
                    <ul>
                        <li>Apple provides test cards within Sandbox tester Apple IDs</li>
                        <li>Load test cards into Wallet on test devices</li>
                        <li>Use Nuvei test currencies / amounts</li>
                        <li>Vary amounts to exercise fraud / auth scenarios</li>
                    </ul>
                </div>
            </div>

            <h3>Functional Test Matrix (Excerpt)</h3>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>Expected</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Eligible device shows Apple Pay button</td>
                            <td>Button visible</td>
                            <td>Device capability true</td>
                        </tr>
                        <tr>
                            <td>Ineligible device hides Apple Pay button</td>
                            <td>No button</td>
                            <td>Fallback to standard checkout</td>
                        </tr>
                        <tr>
                            <td>Successful auth & payment</td>
                            <td>APPROVED</td>
                            <td>Validate DMN + order state</td>
                        </tr>
                        <tr>
                            <td>Decline (insufficient funds)</td>
                            <td>DECLINED</td>
                            <td>Shopper messaging</td>
                        </tr>
                        <tr>
                            <td>Session expired before auth</td>
                            <td>Error; regenerate</td>
                            <td>Force stale sessionToken</td>
                        </tr>
                        <tr>
                            <td>Duplicate submit (double-click)</td>
                            <td>Single auth captured</td>
                            <td>Use idempotency & UI disable</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="launch-checklist" class="content-section">
            <h2>10. Launch Readiness Checklist</h2>
            
            <div class="checklist-grid">
                <div class="checklist-section">
                    <h3>Configuration Freeze</h3>
                    <ul class="checklist">
                        <li>Production credentials validated</li>
                        <li>Domain verification complete</li>
                        <li>SSL certificates active</li>
                        <li>Feature flags configured</li>
                    </ul>
                </div>
                <div class="checklist-section">
                    <h3>Payments Smoke</h3>
                    <ul class="checklist">
                        <li>End-to-end transaction tested</li>
                        <li>DMN webhooks functional</li>
                        <li>Error handling verified</li>
                        <li>Reconciliation process tested</li>
                    </ul>
                </div>
                <div class="checklist-section">
                    <h3>Monitoring & Alerts</h3>
                    <ul class="checklist">
                        <li>Payment success/failure rates</li>
                        <li>Error code tracking</li>
                        <li>Performance metrics</li>
                        <li>Security monitoring</li>
                    </ul>
                </div>
                <div class="checklist-section">
                    <h3>Support / Runbook</h3>
                    <ul class="checklist">
                        <li>Troubleshooting guide</li>
                        <li>Contact escalation paths</li>
                        <li>Common issues documentation</li>
                        <li>Rollback procedures</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="deployment-timeline" class="content-section">
            <h2>11. Deployment Plan & Timeline</h2>
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>Technical Discovery</h3>
                        <span class="timeline-duration">3 days</span>
                        <p>All prereqs collected; domains listed; Apple & Nuvei accounts confirmed</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>Sandbox Build</h3>
                        <span class="timeline-duration">1 week</span>
                        <p>End-to-end happy path in INT; DMNs working</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>QA Regression</h3>
                        <span class="timeline-duration">1 week</span>
                        <p>Functional matrix green; error handling verified</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>UAT / Pilot (Internal)</h3>
                        <span class="timeline-duration">3-5 days</span>
                        <p>Internal Apple devices; accounting reconciliation</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>Limited Prod Launch</h3>
                        <span class="timeline-duration">3 days</span>
                        <p>Key metrics stable (&lt;1% increase in declines)</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>Full Prod Rollout</h3>
                        <span class="timeline-duration">Go/No-Go</span>
                        <p>Exec sign-off; monitoring active</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="appendix" class="content-section">
            <h2>12. Appendix</h2>
            
            <div class="appendix-section">
                <h3>A. Sample Backend /openOrder (Node/Pseudo)</h3>
                <div class="callout callout-info">
                    <strong>API Endpoints:</strong><br>
                    • Test: <code>https://ppp-test.nuvei.com/ppp/api/v1/</code><br>
                    • Live: <code>https://secure.safecharge.com/</code>
                </div>
                <pre><code class="language-javascript">import crypto from 'crypto';
import fetch from 'node-fetch';

async function openOrder({amount,currency,country,email,clientRequestId}) {
  const timeStamp = new Date().toISOString().replace(/[-:TZ.]/g,'').slice(0,14); // YYYYMMDDHHmmss
  const checksumStr = [MERCHANT_ID, MERCHANT_SITE_ID, clientRequestId, amount, currency, timeStamp, MERCHANT_SECRET_KEY].join('');
  const checksum = crypto.createHash('sha256').update(checksumStr).digest('hex');

  const payload = {
    merchantId: MERCHANT_ID,
    merchantSiteId: MERCHANT_SITE_ID,
    clientRequestId,
    amount,
    currency,
    timeStamp,
    checksum,
    country,
    email,
    urlDetails: { notificationUrl: NUVEI_NOTIFICATION_URL }
  };

  const resp = await fetch(`${NUVEI_API_BASE}/openOrder.do`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  return resp.json();
}</code></pre>
            </div>

            <div class="appendix-section">
                <h3>B. Troubleshooting Quick Reference</h3>
                <div class="table-container">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Symptom</th>
                                <th>Likely Cause</th>
                                <th>Fix</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Apple Pay button never appears</td>
                                <td>Capability check fails; domain not verified; non-Safari; JS error</td>
                                <td>Confirm ApplePaySession defined; domain registered; correct merchantIdentifier</td>
                            </tr>
                            <tr>
                                <td>Invalid session token errCode 1064</td>
                                <td>Expired or reused sessionToken</td>
                                <td>Generate new /openOrder and re-init WebSDK</td>
                            </tr>
                            <tr>
                                <td>Shopper stuck on processing</td>
                                <td>Gateway pending; network drop</td>
                                <td>Poll /getPaymentStatus; surface spinner + retry</td>
                            </tr>
                            <tr>
                                <td>Apple Pay requires 3DS (9101)</td>
                                <td>Issuer/regional SCA rule</td>
                                <td>Coordinate with Nuvei to enable 3DS Apple Pay path</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="glossary" class="content-section">
            <h2>13. Glossary</h2>
            <div class="glossary-grid">
                <div class="glossary-item">
                    <strong>APM</strong> – Alternative Payment Method
                </div>
                <div class="glossary-item">
                    <strong>UPO</strong> – User Payment Option (Nuvei tokenized stored payment method)
                </div>
                <div class="glossary-item">
                    <strong>DMN</strong> – Direct Merchant Notification (Nuvei webhook callback)
                </div>
                <div class="glossary-item">
                    <strong>MIT</strong> – Merchant-Initiated Transaction (subsequent, no shopper present)
                </div>
                <div class="glossary-item">
                    <strong>SCA</strong> – Strong Customer Authentication (PSD2 / similar regs)
                </div>
            </div>
        </section>

        <footer class="document-footer">
            
            <div class="footer-meta">
                <p>Nuvei Apple Pay WebSDK - Technical Launch Plan v1.0 | July 21, 2025</p>
            </div>
        </footer>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
