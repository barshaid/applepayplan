<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuve                        <tr>
                            <td><code>externalTokenProvider</code></td>
                            <td><code>paymentOption.card.externalToken</code></td>
                            <td>Yes</td>
                            <td>Must be literal <code>GooglePay</code></td>
                        </tr>
                        <tr>
                            <td><code>token</code></td>
                            <td><code>paymentOption.card.externalToken</code></td>
                            <td>Yes</td>
                            <td>Encrypted Google Pay token from Google Pay JS</td>
                        </tr>
                        <tr>
                            <td><code>googlePay3Dflow</code></td>ebSDK - Technical Launch Plan</title>
    <meta name="description" content="Technical implementation guide for Nuvei Google Pay WebSDK integration">
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css">
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Nuvei Google Pay</h2>
            <p>WebSDK Guide</p>
            <button id="theme-toggle" class="theme-toggle-button">
                <svg id="theme-toggle-light-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
        <ul class="nav-list" id="nav-list">
            <!-- Navigation will be generated by JavaScript -->
        </ul>
    </nav>

    <main class="main-content">
        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle navigation">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <header class="document-header">
            <div class="header-badge">Technical Documentation</div>
            <h1>Nuvei Google Pay via WebSDK</h1>
            <p class="subtitle">Technical & Launch Plan</p>
            <div class="document-meta">
                <div class="meta-item">
                    <span class="meta-label">Version:</span>
                    <span class="meta-value">1.0</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Last Updated:</span>
                    <span class="meta-value">July 21, 2025</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Target Readers:</span>
                    <span class="meta-value">Front‑end engineers, back‑end engineers, solution architects, QA, InfoSec, Product/PM, Launch/Ops, Support.</span>
                </div>
            </div>
        </header>


        <section id="purpose-scope" class="content-section">
            <h2>1. Purpose & Scope</h2>
            <p>Integrate <strong>Google Pay</strong> as an Alternative Payment Method (APM) in our browser checkout using the <strong>Nuvei WebSDK</strong>. The integration will:</p>
            <ul class="feature-list">
                <li>Display a Google Pay button that triggers the Google Pay sheet.</li>
                <li>Collect the encrypted Google Pay payment token returned by Google Pay JS.</li>
                <li>Submit a <code>createPayment()</code> call through Nuvei WebSDK using the <code>externalTokenProvider = "GooglePay"</code> payload.</li>
                <li>Support both Sandbox and Production environments with the correct <code>gatewayMerchantId</code> values (<code>googletest</code> vs <code>nuveidigital</code>).</li>
                <li>Optionally support recurring flows (initial + subsequent) via Nuvei UPOs.</li>
            </ul>
            <div class="callout callout-warning">
                <strong>Out of scope:</strong> Native Android SDK flows, Payment Page /IFrame flows, direct REST decryption (except Appendix reference), payouts.
            </div>
        </section>

        <section id="architecture" class="content-section">
            <h2>2. High‑Level Architecture & Data Flow</h2>
            
        </section>

        <section id="prerequisites" class="content-section">
            <h2>3. Prerequisites Checklist</h2>
            <div class="checklist-category">
                <h3>Merchant / Org Requirements</h3>
                <ul class="checklist">
                    <li>Active <strong>Nuvei Account</strong> in Sandbox and Production.</li>
                    <li><strong>Secret Key</strong> stored server‑side only.</li>
                    <li>Google Pay enabled on the Nuvei account (request via account manager).</li>
                </ul>
            </div>
            <div class="checklist-category">
                <h3>Google Registration & Compliance</h3>
                <ul class="checklist">
                    <li>The checkout domain must be verified with Google.</li>
                    <li>Follow Google Pay Brand Guidelines for button assets, placement, and minimum sizes.</li>
                    <li>Use the gateway merchant IDs exactly as follows: Sandbox: <code>googletest</code>, Production: <code>nuveidigital</code>.</li>
                    <li>HTTPS (TLS 1.2+) required on every page hosting the button.</li>
                    <li>Google test accounts must be loaded with <strong>Google Pay test cards</strong> during QA.</li>
                </ul>
            </div>
            <div class="checklist-category">
                <h3>Device / Browser Requirements</h3>
                <ul class="checklist">
                    <li>Chrome v70+, Edge v79+, or WebView with Google Pay service; user signed‑in to Google account with a payment method.</li>
                </ul>
            </div>
            <div class="checklist-category">
                <h3>Internal Engineering Prep</h3>
                <ul class="checklist">
                    <li>Decide on surfaces for the express Google Pay button (product page, cart, checkout step).</li>
                    <li>Currency & country eligibility mapping.</li>
                    <li>Tax/amount parity between standard card flow and GPay express.</li>
                </ul>
            </div>
        </section>

        <section id="environments" class="content-section">
            <h2>4. Environments, Credentials & Endpoints</h2>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Environment</th>
                            <th>Nuvei <code>env</code></th>
                            <th>Google <code>gatewayMerchantId</code></th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Sandbox / INT</td>
                            <td><code>int</code></td>
                            <td><code>googletest</code></td>
                            <td>Use Google test cards + Nuvei INT hosts</td>
                        </tr>
                        <tr>
                            <td>Production</td>
                            <td><code>prod</code></td>
                            <td><code>nuveidigital</code></td>
                            <td>Live traffic</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="callout callout-security">
                <strong>Credential Handling</strong> – identical practice to Apple Pay: store all secrets server‑side, rotate regularly, never expose in JS bundles.
            </div>
        </section>

        <section id="key-parameters" class="content-section">
            <h2>5. Key Nuvei Objects & Parameters (Google Pay via WebSDK)</h2>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Location</th>
                            <th>Required</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>sessionToken</code></td>
                            <td>From /openOrder → WebSDK</td>
                            <td>Yes</td>
                            <td>Authenticates session</td>
                        </tr>
                        <tr>
                            <td><code>externalTokenProvider</code></td>
                            <td><code>paymentOption.card.externalToken</code></td>
                            <td>Yes</td>
                            <td>Must be literal <code>GooglePay</code></td>
                        </tr>
                        <tr>
                            <td><code>mobileToken</code></td>
                            <td><code>paymentOption.card.externalToken</code></td>
                            <td>No</td>
                            <td>Encrypted Google Pay token</td>
                        </tr>
                        <tr>
                            <td><code>googlePay3Dflow</code></td>
                            <td>Root of <code>createPayment()</code></td>
                            <td>Optional (default `enable`)</td>
                            <td>Controls 3DS routing; `disable` for non‑3DS flow.</td>
                        </tr>
                        <tr>
                            <td><code>userTokenId</code></td>
                            <td>Optional [Rec]</td>
                            <td>Enables UPO storage for recurring</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="implementation" class="content-section">
            <h2>6. Implementation Workstream Overview</h2>
            <h3>6.1 Back‑end Tasks</h3>
            <p>Same pattern as Apple Pay: wrapper for <code>/openOrder</code>, DMN listener, <code>/getPaymentStatus</code> fallback, observability, SB/PROD config management.</p>
            
            <h3>6.2 Front‑end Tasks (Google Pay Button + WebSDK)</h3>
            <div class="callout callout-warning">
                <strong>Important:</strong> Unlike Apple Pay, the Nuvei WebSDK <strong>does not</strong> generate the Google Pay button for you. You embed Google’s JS library, render the button, and then pass the returned <code>paymentData</code> token into <code>sfc.createPayment()</code>.
            </div>

            <h4>1. Include libraries</h4>
            <pre><code class="language-html">&lt;!-- Google Pay JS SDK --&gt;
&lt;script async src="https://pay.google.com/gp/p/js/pay.js"&gt;&lt;/script&gt;
&lt;!-- Nuvei WebSDK --&gt;
&lt;script src="https://cdn.safecharge.com/safecharge_resources/v1/websdk/safecharge.js"&gt;&lt;/script&gt;</code></pre>

            <h4>2. Define the payment configuration</h4>
            <pre><code class="language-javascript">const tokenizationSpecification = {
  type: "PAYMENT_GATEWAY",
  parameters: {
    gateway: "nuveidigital",          // constant
    gatewayMerchantId: "googletest"   // 'googletest' (SB) or 'nuveidigital' (PROD)
  }
};</code></pre>

            <h4>3. Initialize Google Pay & render button</h4>
            <pre><code class="language-javascript">const paymentsClient = new google.payments.api.PaymentsClient({ environment: 'TEST' });
const button = paymentsClient.createButton({
  onClick: onGooglePayPressed,
  buttonType: 'buy',
  buttonColor: 'black'
});
document.getElementById('google-pay-button-container').appendChild(button);</code></pre>

            <h4>4. Handle click → retrieve token → call WebSDK</h4>
            <pre><code class="language-javascript">async function onGooglePayPressed() {
  try {
    const paymentData = await paymentsClient.loadPaymentData({
      apiVersion: 2,
      apiVersionMinor: 0,
      allowedPaymentMethods: [/* …card parameters… */],
      tokenizationSpecification,
      merchantInfo: { merchantName: 'Your Company' },
      transactionInfo: { totalPriceStatus: 'FINAL', totalPrice: '19.99', currencyCode: 'USD' }
    });

    // Extract the encrypted token
    const gpayToken = paymentData.paymentMethodData.tokenizationData.token;

    sfc.createPayment({
      sessionToken: window.sessionToken,
      merchantId: window.merchantId,
      merchantSiteId: window.merchantSiteId,
      paymentOption: {
        card: {
          externalToken: {
            externalTokenProvider: 'GooglePay',
            token: gpayToken
          }
        }
      },
      googlePay3Dflow: 'enable', // or 'disable' if configured
      billingAddress: { email: window.shopperEmail, country: 'US' }
    }, handlePaymentResponse);
  } catch (err) {
    console.error('Google Pay failed', err);
  }
}</code></pre>

            <h4>5. Result handling</h4>
            <p>Identical best practices: treat WebSDK response as preliminary; confirm with DMN; disable button to avoid double submit.</p>

            <h3>6.3 Controlling 3DS Flow</h3>
            <p>Set <code>googlePay3Dflow = "enable"</code> (default) or <code>disable</code> in <code>createPayment()</code> to toggle 3DS.</p>

            <h3>6.4 Recurring / Card‑on‑File (COF)</h3>
            <ul>
                <li><strong>Initial shopper‑present transaction:</strong> include <code>userTokenId</code> in <code>/openOrder</code>; <code>isRebilling = 0</code>.</li>
                <li>Nuvei returns <code>userPaymentOptionId</code>; store server‑side.</li>
                <li><strong>Subsequent MIT:</strong> server‑side REST call referencing stored UPO, not WebSDK.</li>
            </ul>
        </section>


        <section id="error-handling" class="content-section">
            <h2>8. Error Handling & Idempotency</h2>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Context</th>
                            <th>Typical Error</th>
                            <th>Handling</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>WebSDK immediate response</td>
                            <td><code>DECLINED</code>, <code>ERROR</code>, <code>PENDING</code></td>
                            <td>Show user‑friendly copy; poll <code>/getPaymentStatus</code></td>
                        </tr>
                        <tr>
                            <td>Google Pay JS promise rejects</td>
                            <td><code>PAYMENT_DATA_INVALID</code>, network abort</td>
                            <td>Offer retry / fallback card form</td>
                        </tr>
                        <tr>
                            <td>Nuvei errCode 1064</td>
                            <td>Invalid/expired <code>sessionToken</code></td>
                            <td>Regenerate order</td>
                        </tr>
                        <tr>
                            <td>Nuvei errCode 9072</td>
                            <td>Payment in progress</td>
                            <td>Spinner + poll status</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="security" class="content-section">
            <h2>9. Security, Compliance & Data Handling</h2>
            <ul class="checklist">
                <li>Do <strong>not</strong> log the full Google Pay token; mask after first 8 / last 8 chars.</li>
                <li>PCI DSS SAQ‑A or A‑EP applies depending on if token passes through your server.</li>
                <li>Follow Google’s data retention rules; never store PAN.</li>
                <li>Enforce Content‑Security‑Policy to allow only <code>https://pay.google.com</code> frames.</li>
            </ul>
        </section>

        <section id="testing" class="content-section">
            <h2>10. Testing Strategy</h2>
            <h3>10.1 Test Environments</h3>
            <ul class="checklist">
                <li>Nuvei INT + <code>googletest</code> gatewayMerchantId</li>
                <li>Google Pay <strong>TEST</strong> environment via PaymentsClient</li>
            </ul>
            <h3>10.2 Test Data</h3>
            <ul class="checklist">
                <li>Google Pay Test Card Suite (see Google docs).</li>
                <li>Nuvei dummy amounts to exercise approval/decline codes.</li>
            </ul>
            <h3>10.3 Functional Matrix (Excerpt)</h3>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>Expected</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Eligible browser shows GPay button</td>
                            <td>Button visible</td>
                        </tr>
                        <tr>
                            <td>Unsupported browser hides button</td>
                            <td>No button</td>
                        </tr>
                        <tr>
                            <td>Successful auth & payment</td>
                            <td>APPROVED via DMN</td>
                        </tr>
                        <tr>
                            <td>Decline due to insuff. funds</td>
                            <td>DECLINED message</td>
                        </tr>
                        <tr>
                            <td>3DS enforced</td>
                            <td>Challenge flow displays</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="launch-checklist" class="content-section">
            <h2>11. Launch Readiness Checklist</h2>
            
            <div class="checklist-grid">
                <div class="checklist-section">
                    <h3>Configuration Freeze</h3>
                    <ul class="checklist">
                        <li>Production credentials validated</li>
                        <li>Domain verification complete with Google</li>
                        <li>SSL certificates active</li>
                        <li>Feature flags configured</li>
                    </ul>
                </div>
                <div class="checklist-section">
                    <h3>Payments Smoke</h3>
                    <ul class="checklist">
                        <li>End-to-end transaction tested in Production</li>
                        <li>DMN webhooks functional for Google Pay</li>
                        <li>Error handling verified for Google Pay scenarios</li>
                        <li>Reconciliation process tested with live data</li>
                    </ul>
                </div>
                <div class="checklist-section">
                    <h3>Monitoring & Alerts</h3>
                    <ul class="checklist">
                        <li>Payment success/failure rates for Google Pay</li>
                        <li>Error code tracking specific to Google Pay</li>
                        <li>Performance metrics (button load time, payment latency)</li>
                        <li>Security monitoring for new endpoints</li>
                    </ul>
                </div>
                <div class="checklist-section">
                    <h3>Support / Runbook</h3>
                    <ul class="checklist">
                        <li>Troubleshooting guide for Google Pay errors</li>
                        <li>Contact escalation paths for Google/Nuvei issues</li>
                        <li>Common issues documentation updated</li>
                        <li>Rollback procedures defined</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="deployment-timeline" class="content-section">
            <h2>12. Deployment Plan & Timeline</h2>
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>Technical Discovery</h3>
                        <span class="timeline-duration">2-3 days</span>
                        <p>All prereqs collected; domains listed; Google & Nuvei accounts confirmed</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>Sandbox Build</h3>
                        <span class="timeline-duration">1 week</span>
                        <p>End-to-end happy path in INT; DMNs working for Google Pay</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>QA Regression</h3>
                        <span class="timeline-duration">1 week</span>
                        <p>Functional matrix green; error handling verified for Google Pay</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>UAT / Pilot (Internal)</h3>
                        <span class="timeline-duration">3-5 days</span>
                        <p>Internal Google accounts; accounting reconciliation</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>Limited Prod Launch</h3>
                        <span class="timeline-duration">3 days</span>
                        <p>Key metrics stable (&lt;1% increase in declines for Google Pay)</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h3>Full Prod Rollout</h3>
                        <span class="timeline-duration">Go/No-Go</span>
                        <p>Exec sign-off; monitoring active</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="appendix" class="content-section">
            <h2>Appendix</h2>
            <h3>13. Appendix A – Sample /openOrder (Node/Pseudo)</h3>
            <pre><code class="language-js">// Same skeleton as Apple Pay; add userTokenId/isRebilling when needed</code></pre>
            
            <h3>14. Appendix B – Front‑end Snippet (Copy/Paste)</h3>
            <pre><code class="language-html">&lt;div id="google-pay-button-container"&gt;&lt;/div&gt;
&lt;script async src="https://pay.google.com/gp/p/js/pay.js"&gt;&lt;/script&gt;
&lt;script src="https://cdn.safecharge.com/safecharge_resources/v1/websdk/safecharge.js"&gt;&lt;/script&gt;
&lt;!-- plus the JS from §6.2 --&gt;</code></pre>

            <h3>15. Appendix C – Troubleshooting Quick Hits</h3>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Symptom</th>
                            <th>Likely Cause</th>
                            <th>Fix</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Button not showing</td>
                            <td>Browser/device not eligible; script blocked</td>
                            <td>Check <code>window.google</code>; CSP headers</td>
                        </tr>
                        <tr>
                            <td><code>gatewayMerchantId</code> mismatch error</td>
                            <td>Wrong value for env</td>
                            <td>Use <code>googletest</code> in SB; <code>nuveidigital</code> in PROD</td>
                        </tr>
                        <tr>
                            <td><code>googlePay3Dflow</code> ignored</td>
                            <td>Parameter outside root of payload</td>
                            <td>Place at root level</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="glossary" class="content-section">
            <h2>16. Glossary</h2>
            <div class="glossary-grid">
                <div class="glossary-item"><strong>APM</strong> – Alternative Payment Method</div>
                <div class="glossary-item"><strong>UPO</strong> – User Payment Option (stored payment method)</div>
                <div class="glossary-item"><strong>DMN</strong> – Direct Merchant Notification (Nuvei webhook)</div>
                <div class="glossary-item"><strong>MIT</strong> – Merchant‑Initiated Transaction (subsequent)</div>
                <div class="glossary-item"><strong>SCA</strong> – Strong Customer Authentication</div>
            </div>
        </section>

        <footer class="document-footer">
            
            <div class="footer-meta">
                <p>Nuvei Google Pay WebSDK - Technical Launch Plan v1.0 | July 21, 2025</p>
            </div>
        </footer>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script src="js/main.js"></script>
</body>
</html>
